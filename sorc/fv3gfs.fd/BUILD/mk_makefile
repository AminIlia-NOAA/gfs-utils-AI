#!/bin/csh 

set root = $PWD

mkdir -p ${root}/exec

if ( ${2} == "clean" ) then
  echo " cleaning build directory in 4 seconds "
  sleep 4
  rm ${root}/exec/*
endif

cd ${root}/exec/

# GFS CPPDEFS
 set GFS_cppDefs = "-DNEW_TAUCTMAX"

# non-hydrostatic CPPDEFS
 set cppDefs = "-Duse_libMPI -Duse_netCDF -DSPMD -DUSE_LOG_DIAG_FIELD_INFO -Duse_LARGEFILE -DMOIST_CAPPA -DUSE_COND -DUSE_GFSL63 -DGFS_PHYS"

# hydrostatic CPPDEFS
if (${1} == "hydro") then
 set cppDefs = "-Duse_libMPI -Duse_netCDF -DSPMD -DUSE_LOG_DIAG_FIELD_INFO -Duse_LARGEFILE -DUSE_GFSL63 -DGFS_PHYS"
endif

../../site/mkmf -m Makefile_gfs -a ${FV3_GFS_SRC} -t "${TEMPLATE}" -o "-cpp" -c "$GFS_cppDefs" -p libgfs.a pathnames_gfs
sed 's"$(FC) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)gfs_physics/physics/radiation_aerosols.f"$(FC) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -msse3 -c\t$(SRCROOT)gfs_physics/physics/radiation_aerosols.f"' < Makefile_gfs > OUT
mv OUT Makefile_gfs
sed 's"$(FC) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)gfs_physics/physics/radiation_astronomy.f"$(FC) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -xCORE-AVX-I -c\t$(SRCROOT)gfs_physics/physics/radiation_astronomy.f"' < Makefile_gfs > OUT
mv OUT Makefile_gfs

../../site/mkmf -m Makefile_fv3 -a ${FV3_GFS_SRC} -t "${TEMPLATE}" -c "$cppDefs" -p test.x pathnames_fv3

sed 's/LDFLAGS/NCEPLIBS) $(LDFLAGS/g' < Makefile_fv3 > OUT
mv OUT Makefile_fv3
sed 's"$(FC) $(CPPDEFS) $(CPPFLAGS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)atmos_cubed_sphere/model_nh/nh_utils.F90"$(FC) $(CPPDEFS) $(CPPFLAGS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) $(FAST) -c\t$(SRCROOT)atmos_cubed_sphere/model_nh/nh_utils.F90"' < Makefile_fv3 > OUT
mv OUT Makefile_fv3
sed 's"$(FC) $(CPPDEFS) $(CPPFLAGS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) -c\t$(SRCROOT)atmos_cubed_sphere/model/fv_mapz.F90"$(FC) $(CPPDEFS) $(CPPFLAGS) $(FPPFLAGS) $(FFLAGS) $(OTHERFLAGS) $(OTHER_FFLAGS) $(FAST) -c\t$(SRCROOT)atmos_cubed_sphere/model/fv_mapz.F90"' < Makefile_fv3 > OUT
mv OUT Makefile_fv3

exit

